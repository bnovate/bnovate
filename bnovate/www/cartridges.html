{% extends "templates/web.html" %}

{% block page_content %}

<h1>Your cartridges</h1>

<div class="row">
    <div class="col">
        <button id="request-refill" class="btn btn-primary">Request Refill</button>
    </div>
</div>

<div class="row">
    <div class="col">
        <table class="table table-condensed" style="border-bottom: 1px solid #d1d8dd; width:100%">
            <thead>
                <th></th>
                <th>Serial No</th>
                <th>Location</th>
                <th>Status</th>
                <th>Since</th>
                <th>Tracking No</th>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td>
                        <input class="serial-check" type="checkbox" data-serial="{{ row.serial_no }}">
                    </td>
                    <td>{{ row.serial_no }}</td>
                    <td>{{ row.location }}</td>
                    <td>{{ row.status }}</td>
                    <td>{{ row.posting_date }}</td>
                    <td>
                        {% if row.tracking_link %}
                        {{ row.tracking_link }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<wizard-modal id="build-fill-request"></wizard-modal>


{% endblock %}

{% block script %}

<template id="wizard-modal-template">
    
    <div class="modal" tabindex="-1" role="dialog" id="myModal" style="display:none">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Refill</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    
                    <ol class="wizard-ribbon">
                        <li class="wizard-step current" data-step="1">Cartridges</li>
                        <li class="wizard-step" data-step="2">Shipping</li>
                        <li class="wizard-step" data-step="3">Billing</li>
                    </ol>
                    
                    <div class="wizard-page" id="page1">
                        <p>This is the first page of the wizard.</p>
                    </div>
                    
                    <div class="wizard-page" id="page2" style="display: none;">
                        <p>This is the second page of the wizard.</p>
                    </div>
                    
                    <div class="wizard-page" id="page3" style="display: none;">
                        <p>This is the third page of the wizard.</p>
                    </div>
                    <div class="modal-footer">
                        <div class="wizard-buttons">
                            <button type="button" class="btn btn-danger" id="cancelButton">Cancel</button>
                            <button type="button" class="btn btn-secondary" id="prevButton" style="display: none;">Previous</button>
                            <button type="button" class="btn btn-primary" id="nextButton">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
</template>

<script>
    
    customElements.define('wizard-modal', class extends HTMLElement {
        constructor() {
            super();
            
            // Initialize the wizard
            this.currentPage = 1;
            this.numPages = 3; // $(".wizard-page").length;
            
            // Attach template.
            const template = document.getElementById("wizard-modal-template").content;
            this.attachShadow({ mode: "open" });
            this.shadowRoot.appendChild(template.cloneNode(true));
            
            this.modal = this.shadowRoot.getElementById("myModal");
            this.next = this.shadowRoot.getElementById("nextButton");
            this.prev = this.shadowRoot.getElementById("prevButton");
            this.cancel = this.shadowRoot.getElementById("cancelButton");

            $(this.modal).on('show.bs.modal', (e) => {
                this.currentPage = 1;
                this.showPage(this.currentPage);
                e.target.querySelector('.modal-body #page1').innerHTML = '<p>Contents go here</p>';
            })
            
            $(this.modal).on('hide.bs.modal', (e) => {
                // e.target.querySelector('.modal-body #page1').innerHTML = '';
            })
            
            // Add event listeners to the navigation buttons
            $(this.prev).click(() => {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.showPage(this.currentPage);
                }
            });
            
            $(this.next).click(() => {
                console.log("next", this.currentPage, this.numPages)
                if (this.currentPage < this.numPages) {
                    this.currentPage++;
                    this.showPage(this.currentPage);
                }
            });
            
            $(this.cancel).click(() => {
                // Close the modal or redirect to another page
                $(this.modal).modal("hide");
            });
        }
        
        show() {
            $(this.modal).modal('show');
        }
        
        // Show or hide the navigation buttons based on the current page
        updateButtons() {
            if (this.currentPage == 1) {
                $("#prevButton").hide();
            } else {
                $("#prevButton").show();
            }
            
            if (this.currentPage == this.numPages) {
                $("#nextButton").hide();
            } else {
                $("#nextButton").show();
            }
            
            $(".wizard-step").removeClass("current");
            $(`.wizard-step[data-step='${this.currentPage}']`).addClass("current");
        }
        
        // Show the specified page and update the navigation buttons
        showPage(page) {
            $(".wizard-page").hide();
            $("#page" + page).show();
            this.updateButtons();
        }
    })
    
    frappe.require("/assets/bnovate/js/web_includes/helpers.js")
    
    function get_selected() {
        let serial_nos = [...document.querySelectorAll(".serial-check")]
        .filter(c => c.checked)
        .map(c => c.dataset.serial);
        
        return serial_nos;
    }
    
    function build_request(serial_nos) {
        data = {
            shipping_address: null,
            billing_address: null,
            items: [],
        }
        
        data.items = serial_nos.map( no => ({serial_no: no, type: "ICC"}));
        return data
    }
    
    async function post_request(data) {
        const resp = await frappe.call("bnovate.www.request.make_request", {
            data
        })
        return resp.message
    }
    
    document.querySelector("#request-refill").addEventListener("click", async () => {
        document.getElementById('build-fill-request').show();
        // <!-- await post_request(build_request(get_selected())); -->
    });
    
    
    // Wizard controls
    // --------------------------------------------
    
    
</script>

{% endblock %}

{% block style %}
<style>
    /* Style needs to be defined outside of shadow DOM. */
    :root {
        --number-of-steps: 4;
        --line-width: 2px;
        --bullet-size: 2em;
        
        --line-color: #ffa632;
        --label-color: #575757;
        --completed-background-color: #ffecd4;
        --uncompleted-background-color: #ffffffff;
        
    }
    
    .wizard-ribbon {
        display: flex;
        /* justify-content: space-between; */
        align-items: center;
        margin-bottom: 1rem;
    }
    
    ol.wizard-ribbon {
        position: relative;
        overflow: hidden;
        counter-reset: wizard 0;
        list-style-type: none;
    }
    
    .wizard-ribbon li {
        position: relative;
        float: left;
        width: calc(100% / var(--number-of-steps));
        text-align: center;
        /* color: var(--active-background-color); */
    }
    
    .wizard-ribbon .current ~ li {
        color: var(--label-color);
    }
    
    .wizard-ribbon li:before {
        counter-increment: wizard;
        content: counter(wizard);
        display: block;
        color: var(--line-color);
        background-color: var(--completed-background-color);
        border: var(--line-width) solid var(--line-color);
        text-align: center;
        width: var(--bullet-size);
        height: var(--bullet-size);
        line-height: var(--bullet-size);
        border-radius: var(--bullet-size);
        position: relative;
        left: 50%;
        margin-bottom: calc(var(--bullet-size) / 2);
        margin-left: calc(var(--bullet-size) * -0.5);
        z-index: 1;
    }
    
    .wizard-ribbon .current ~ li:before {
        background-color: var(--uncompleted-background-color);
        color: var(--line-color);
        border-color: var(--line-color);
    }
    
    .wizard-ribbon li + li:after {
        content: "";
        display: block;
        width: 100%;
        background-color: var(--line-color);
        height: var(--line-width);
        position: absolute;
        left: -50%;
        top: calc(var(--bullet-size) / 2);
        z-index: 0;
    }
    
    .wizard-ribbon .current ~ li:after {
        background-color: var(--line-color);
    }
</style>
{% endblock %}